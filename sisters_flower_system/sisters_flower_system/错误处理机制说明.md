# 姐妹花销售系统 - 错误处理机制说明

## 概述

本系统已完善集成了全面的错误处理机制，确保系统的稳定性和用户体验。错误处理系统采用多层次、多策略的防护方案。

## 系统架构

### 1. 核心组件

#### 1.1 LogManager (日志管理器)
- **功能**: 统一管理所有日志记录
- **特性**:
  - 多文件日志记录 (main.log, error.log, business.log)
  - 分类日志管理
  - 自动日志轮转
  - 统一日志格式

#### 1.2 GlobalExceptionHandler (全局异常处理器)
- **功能**: 捕获和处理系统中的所有异常
- **特性**:
  - 全局异常捕获
  - Tkinter异常处理
  - 错误对话框显示
  - 自动重试机制
  - 错误统计收集

#### 1.3 DatabaseManager (数据库管理器)
- **功能**: 管理数据库连接、事务和错误处理
- **特性**:
  - 连接池管理
  - 自动重试机制
  - 数据库完整性验证
  - 自动备份
  - 事务管理

#### 1.4 RetryManager (重试管理器)
- **功能**: 实现自动重试和降级机制
- **特性**:
  - 可配置重试策略
  - 指数退避算法
  - 降级机制
  - 抖动算法

#### 1.5 HealthChecker (系统健康检查器)
- **功能**: 监控系统运行状态
- **检查项**:
  - 数据库完整性
  - 磁盘空间使用
  - 内存使用率
  - 错误率监控

#### 1.6 BackupManager (备份管理器)
- **功能**: 自动备份和数据恢复
- **特性**:
  - 自动备份调度
  - 备份验证
  - 旧备份清理
  - 数据完整性校验

#### 1.7 ErrorUIHandler (UI错误处理器)
- **功能**: 管理用户界面中的错误状态显示
- **特性**:
  - 状态栏错误显示
  - 错误消息推送
  - 自动错误清除
  - 状态颜色编码

## 使用方法

### 2.1 初始化错误处理系统

```python
# 在主应用中自动初始化
app = EnhancedSalesSystem(current_user)
error_handlers = initialize_error_handling(
    log_dir="logs",
    db_path="database.db"
)
```

### 2.2 使用错误处理装饰器

```python
@with_error_handling(retry=True, show_dialog=True)
def your_function():
    # 您的业务代码
    pass
```

### 2.3 使用错误处理上下文管理器

```python
with error_context("Database operation", show_dialog=True):
    # 数据库操作
    pass
```

### 2.4 手动错误处理

```python
try:
    # 执行可能出错的操作
    risky_operation()
except Exception as e:
    handle_error(e, "risky_operation", show_dialog=True, retry=True)
```

## 错误类型与处理策略

### 3.1 错误分类

#### 3.1.1 系统级错误
- 磁盘空间不足
- 内存不足
- 系统资源耗尽
- 权限问题

#### 3.1.2 数据库错误
- 连接失败
- SQL语法错误
- 数据完整性违反
- 锁竞争

#### 3.1.3 网络错误
- 连接超时
- 网络不可达
- 服务端错误

#### 3.1.4 业务逻辑错误
- 输入验证失败
- 业务规则违反
- 状态不一致

### 3.2 重试策略

```python
# 记录重试策略
retry_policies = {
    'database_operation': {
        'max_attempts': 3,
        'base_delay': 1.0,
        'max_delay': 60.0,
        'backoff_factor': 2.0,
        'jitter': True
    },
    'network_operation': {
        'max_attempts': 5,
        'base_delay': 0.5,
        'max_delay': 30.0,
        'backoff_factor': 1.5,
        'jitter': True
    }
}
```

## 日志系统

### 4.1 日志文件结构

```
logs/
├── main.log          # 主日志（所有级别）
├── error.log         # 错误日志（ERROR及以上）
├── business.log      # 业务日志
└── backups/          # 数据库备份目录
    ├── auto_backup_20241201_120000.db
    └── auto_backup_20241201_130000.json
```

### 4.2 日志级别

- **DEBUG**: 调试信息
- **INFO**: 一般信息
- **WARNING**: 警告信息
- **ERROR**: 错误信息
- **CRITICAL**: 严重错误

## 健康监控

### 5.1 监控指标

- **系统状态**: healthy, degraded, unhealthy, error
- **数据库状态**: 连接、完整性、性能
- **资源使用**: CPU、内存、磁盘
- **错误率**: 每小时错误数量

### 5.2 告警阈值

```python
alert_thresholds = {
    'cpu_usage': 80,      # CPU使用率超过80%
    'memory_usage': 85,   # 内存使用率超过85%
    'disk_usage': 90,     # 磁盘使用率超过90%
    'error_rate': 10,     # 每小时错误数量超过10个
}
```

## 备份机制

### 6.1 自动备份

- **频率**: 每24小时自动备份
- **保留期**: 30天
- **验证**: 备份完成后自动验证完整性

### 6.2 手动备份

```python
# 创建手动备份
backup_path = backup_manager.create_backup("manual_backup_20241201")
```

### 6.3 数据恢复

```python
# 从备份恢复
success = backup_manager.restore_backup("backups/auto_backup_20241201_120000.db")
```

## UI错误处理

### 7.1 状态栏显示

- **健康状态指示器**: 绿色(正常)、橙色(警告)、红色(异常)
- **错误计数**: 显示当前会话错误数量
- **状态消息**: 实时显示系统状态

### 7.2 错误对话框

- 友好的错误消息
- 详细的错误信息（可选择显示）
- 自动重试选项
- 联系方式信息

## 最佳实践

### 8.1 错误处理原则

1. **分层处理**: 不同层级使用不同的错误处理策略
2. **用户体验**: 错误信息应用户友好
3. **日志记录**: 所有异常都应该被记录
4. **优雅降级**: 在可能的情况下提供降级服务
5. **自动恢复**: 优先使用自动重试和恢复机制

### 8.2 代码规范

```python
# ✅ 推荐的错误处理方式
try:
    result = database_operation()
except sqlite3.OperationalError as e:
    handle_error(e, "database_operation", retry=True)
    return default_value
```

```python
# ❌ 不推荐的处理方式
try:
    result = database_operation()
except Exception as e:
    print(f"Error: {e}")  # 没有记录日志
    return None          # 没有处理或重试
```

## 故障排除

### 9.1 常见问题

#### 9.1.1 日志文件过大
- **原因**: 错误率过高或日志级别设置不当
- **解决**: 调整日志级别，定期清理旧日志

#### 9.1.2 数据库连接失败
- **原因**: 数据库文件损坏、权限问题、磁盘空间不足
- **解决**: 检查数据库文件，从备份恢复

#### 9.1.3 内存泄漏
- **原因**: 未正确释放资源
- **解决**: 检查资源释放代码，使用内存监控工具

### 9.2 调试模式

```python
# 启用调试模式
log_manager.get_logger("root").setLevel(logging.DEBUG)
```

## 性能影响

### 10.1 性能优化

- 异步日志写入
- 连接池复用
- 智能重试策略
- 资源及时释放

### 10.2 性能监控

- 数据库查询时间
- 内存使用情况
- 错误处理耗时
- 备份恢复时间

## 结论

完善的错误处理机制是系统稳定性的重要保障。本系统集成的错误处理方案提供了：

- ✅ 全面的错误捕获和处理
- ✅ 智能的自动重试机制
- ✅ 完善的日志记录系统
- ✅ 实时的健康状态监控
- ✅ 可靠的备份恢复机制
- ✅ 用户友好的错误显示

通过这些机制，系统能够：
1. **预防错误**: 通过健康检查和预警机制
2. **快速恢复**: 通过自动重试和降级机制
3. **最小化影响**: 通过错误隔离和恢复机制
4. **提供支持**: 通过详细的日志和错误信息

确保系统在各种异常情况下都能稳定运行，为用户提供可靠的服务体验。

---

**版本**: 1.0  
**更新日期**: 2024年12月  
**维护者**: 姐妹花销售系统开发团队